//ICC-AVR application builder : 2012/2/13 20:52:33
/*******************************************************************************
* 版权:     木仔工作室
*
* 单片机:   ATMAGE8
* 晶振:     外部8MHz
* 编译器:   ICC 7.22
*
* 文件名:   main.c
* 作者:     木仔工作室
* 版本:     1.0
* 完成日期: 
* 功能描述: 在8M晶振下,实现8个独立键盘显示6路LED灯
*******************************************************************************/

/*********************************包含头文件********************************/
#include <iom8v.h>
#include <macros.h>
 
#define LED PORTC
/******************************************************************************* 
* 函数名称: delay_us()
* 入口参数: microsecond : 输入延时微秒的时间
* 出口参数: 
* 功能描述: 微秒的延时   	  	
*******************************************************************************/ 
void delay_us(unsigned int microsecond) 
{      
    do 
	{ 
        microsecond--; 
	}         
    while (microsecond>1); 
}
/******************************************************************************* 
* 函数名称: delay_ms()
* 入口参数: millisecond : 输入延时毫秒的时间
* 出口参数: 
* 功能描述: 毫秒的延时  	
*******************************************************************************/ 
void delay_ms(unsigned int millisecond) 
{      
    while (millisecond--)
	{
        delay_us(999);
	}  
}
/******************************************************************************* 
* 函数名称: void key_scan(void)
* 入口参数: 
* 出口参数: 
* 功能描述: 键盘扫描
*******************************************************************************/
void key_scan(void)
{
         PORTB = 0XFF;
		 delay_ms(10);
		 if((PINB&0x3F)!=0x3F)
    	 {
    	   	  delay_ms(20);
        	  if((PINB&0x3F)!=0x3F)
        	  { 
			    switch(PINB)
				{
				    case 0X3E:LED = 1;break;//S1
					case 0X3D:LED = 4;break;//S4
					case 0X3B:LED = 2;break;//S2
					case 0X37:LED = 6;break;//S6
					case 0X2F:LED = 8;break;//S8
					case 0X1F:LED = 5;break;//S5
					default:LED = 0XFF;break;
				}				
				delay_ms(1);
			  }
          }
		 
		 PORTC |=BIT(4)|BIT(5);
		 delay_ms(10);
		 if((PINC&0x30)!=0x30)
    	 {
    	   	  delay_ms(20);
        	  if((PINC&0x30)!=0x30)
        	  { 
			    switch(PINC&0X30)
				{
				    case 0X10:LED = 7;break;//S7
					case 0X20:LED = 3;break;//S3
					default:LED = 0XFF;break;
				}				
				delay_ms(1);
			  }
          }
}
/******************************************************************************* 
* 函数名称: 
* 入口参数: 
* 出口参数: 
* 功能描述: 
*******************************************************************************/ 
void port_int(void)
{
      //stop errant interrupts until set up
     CLI(); //disable all interrupts
     DDRB = 0XC0;
	 PORTB = 0XFF;
	 DDRC  = 0x3F;
     PORTC = 0xFF; 
	 MCUCR = 0x00;
	 GICR  = 0x00;
	 TIMSK = 0x00; //timer interrupt sources
	 SEI();
}
/****************************************************************************
函数功能:延时子程序
入口参数:
出口参数:
****************************************************************************/
void delay(void)
{
 	 int i;
  	 for(i=0;i<200;i++);
}
/****************************************************************************
函数功能:主程序
入口参数:
出口参数:
****************************************************************************/
void main(void)
{
	 port_int();
	 LED = 0XFF;
	 while(1)
	 {
	    key_scan(); 
	 }
}